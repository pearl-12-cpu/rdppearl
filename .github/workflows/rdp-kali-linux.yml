
name: Kali-RDP-Mobile-Fixed

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Runtime in minutes (max 360)'
        required: false
        default: '180'

jobs:
  kali-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ubuntu Desktop with Security Tools
        run: |
          set -e
          echo "üîß Starting installation process..."
          
          sudo add-apt-repository universe -y
          sudo add-apt-repository multiverse -y
          sudo apt-get update
          
          echo "üìÄ Installing desktop environment..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies \
            xorg xserver-xorg \
            xrdp \
            firefox \
            nano vim curl wget unzip git

          echo "üõ†Ô∏è Installing security tools..."
          sudo apt-get install -y \
            nmap nikto sqlmap gobuster dirb ffuf \
            python3 python3-pip python3-venv \
            john hashcat hydra wireshark tcpdump \
            netcat-openbsd

          # Create user
          sudo useradd -m -s /bin/bash kali 2>/dev/null || true
          echo "kali:kali123456" | sudo chpasswd
          sudo usermod -aG sudo kali

          # FIX: Configure xrdp properly
          sudo sed -i 's/port=3389/port=3390/g' /etc/xrdp/xrdp.ini
          
          # FIX: Create proper startwm.sh
          sudo tee /etc/xrdp/startwm.sh > /dev/null << 'EOF'
          #!/bin/sh
          if [ -r /etc/default/locale ]; then
          . /etc/default/locale
          export LANG LANGUAGE
          fi
          export XDG_SESSION_TYPE=x11
          export XDG_DATA_DIRS=/usr/share/xfce4:/usr/share:/usr/local/share
          export XDG_CONFIG_DIRS=/etc/xdg
          export XDG_CURRENT_DESKTOP=XFCE
          export XDG_SESSION_DESKTOP=xfce
          startxfce4
          EOF

          sudo chmod +x /etc/xrdp/startwm.sh

          # Start RDP service on port 3390
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

          echo "‚úÖ Desktop environment ready!"

      - name: Install Additional Python Tools
        run: |
          pip3 install requests bs4 scrapy
          echo "‚úÖ Python tools installed"

      - name: Download and Setup Playit
        run: |
          echo "üì• Downloading playit..."
          # Download working version
          wget -q "https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-linux-amd64" -O playit || \
          wget -q "https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-linux-x86_64" -O playit
          
          chmod +x playit
          sudo mv playit /usr/local/bin/
          echo "‚úÖ Playit installed"

      - name: Setup Playit Tunnel (FIXED PORT)
        env:
          PLAYIT_KEY: ${{ secrets.PL }}
        run: |
          echo "üåê Setting up Playit tunnel..."
          
          # Start playit (it will auto-detect RDP on 3390)
          /usr/local/bin/playit --secret "$PLAYIT_KEY" 2>&1 | tee playit.log &
          TUNNEL_PID=$!
          
          # Wait for tunnel
          echo "‚è≥ Waiting for tunnel..."
          for i in {1..60}; do
            if grep -q "tunnel running" playit.log; then
              echo "‚úÖ Tunnel active!"
              break
            fi
            sleep 1
          done
          
          # Extract the CORRECT address (should show 3390 now)
          echo "üìã Looking for RDP tunnel on port 3390..."
          sleep 10
          
          # Get the tunnel address
          TUNNEL_INFO=$(grep -A2 "TUNNELS" playit.log | tail -1)
          echo "Tunnel info: $TUNNEL_INFO"
          
          # Extract address
          ADDRESS=$(echo "$TUNNEL_INFO" | grep -oP '\S+\.ply\.gg:\d+')
          
          if [ -n "$ADDRESS" ]; then
            echo ""
            echo "üéØ üéØ üéØ RDP CONNECTION DETAILS üéØ üéØ üéØ"
            echo ">>> RDP ADDRESS: $ADDRESS <<<"
            echo "Username: kali"
            echo "Password: kali123456"
            echo ""
            echo "üí° If connection fails, also try the default port 3389:"
            echo "Address: $(echo $ADDRESS | cut -d: -f1):3389"
          else
            echo "üìã Full tunnel info:"
            grep -A5 "TUNNELS" playit.log
            echo "üë§ Username: kali"
            echo "üîë Password: kali123456"
            echo "üåê Check: https://playit.gg/account/tunnels"
          fi

      - name: Keep Alive with Countdown
        run: |
          DURATION=${{ github.event.inputs.duration || 180 }}
          echo "üïê RDP session active for $DURATION minutes"
          echo "üí° If XFCE fails, try these sessions in order:"
          echo "1. Xorg (recommended)"
          echo "2. Xvnc" 
          echo "3. neutrinordp-any"
          
          MINUTES=$DURATION
          for ((i=MINUTES; i>0; i--)); do
            echo "‚è≥ Time remaining: ${i} minutes"
            sleep 60
          done
          echo "‚ùå Session ending now"
