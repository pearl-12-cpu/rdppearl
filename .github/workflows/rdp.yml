
name: TOOLBOXLAP

on:
  workflow_dispatch:
    inputs:
      chain:
        description: 'internal flag, leave empty'
        required: false
        default: 'false'

  schedule:
    - cron: '0 */12 * * *'   # 00:00 and 12:00 UTC every day

jobs:
  setup-rdp-tunnel:
    runs-on: windows-latest
    timeout-minutes: 360          # 6 h hard cap

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Playit
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-windows-x86_64-signed.exe" -OutFile "$env:USERPROFILE\playit.exe"

    - name: Configure RDP
      shell: pwsh
      env:
        PASS: ${{ secrets.RDP_PASS }}
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
        Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText $env:PASS -Force)

    - name: Launch Playit tunnel
      shell: pwsh
      env:
        PLAYIT_AUTH_KEY: ${{ secrets.PL }}
      run: |
        Start-Process "$env:USERPROFILE\playit.exe" -ArgumentList "--secret",$env:PLAYIT_AUTH_KEY -NoNewWindow -PassThru
        Start-Sleep 5
        
    - name: Show tunnel address
      shell: pwsh
      run: |
        # legacy agent: read the JSON file it drops in %APPDATA%
        $tunFile = "$env:APPDATA\playit\tunnel_info.json"
        for ($i=0; $i -lt 30; $i++) {          # max 30 s
          if (Test-Path $tunFile) { break }
          Start-Sleep 1
        }
        if (-not (Test-Path $tunFile)) {
          Write-Host "tunnel_info.json not found after 30 s"
          exit 1
        }
        $info = Get-Content $tunFile | ConvertFrom-Json
        # pick the mapping whose local port is 3389
        $rdp = $info.tunnels | Where-Object { $_.local_port -eq 3389 }
        if (-not $rdp) {
          Write-Host "No tunnel on port 3389"
          exit 1
        }
        $addr = "$($rdp.host):$($rdp.port)"
        Write-Host ">>> RDP ADDRESS: $addr <<<"

        
    # ---------- chaining logic ----------
    - name: Queue follow-up job (only once)
      if: github.event.inputs.chain != 'true'
      shell: pwsh
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # push the same workflow with chain=true so the next job won't loop forever
        gh workflow run '${{ github.workflow }}' -f chain=true

    # ---------- keep alive ----------
    - name: Keep runner alive
      shell: pwsh
      run: Start-Sleep 21600        # 6 h
      
