
name: Kali-Ubuntu-RDP

on:
  workflow_dispatch:
    inputs:
      chain: { description: 'internal', required: false, default: 'false' }
  schedule:
    - cron: '0 */12 * * *'          # twice a day, gapless 12 h coverage

jobs:
  kali-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360            # 6 h hard cap

    steps:
      - uses: actions/checkout@v4

      - name: Install Kali tools + desktop + xrdp + playit
        run: |
          # 1.  add Kali repo + keys
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys ED444FF07D8D0BF6 ED65462EC8D5E4C5
          echo "deb http://http.kali.org/kali kali-rolling main non-free contrib" | sudo tee /etc/apt/sources.list.d/kali.list

          # 2.  APT pin: accept Kali *binaries* but never overwrite Ubuntu base
          sudo tee /etc/apt/preferences.d/kali-pin <<'EOF'
          Package: *
          Pin: release o=Kali
          Pin-Priority: 100

          Package: metasploit-framework nmap burpsuite john hashcat gobuster dirb sqlmap ffuf feroxbuster impacket-scripts
          Pin: release o=Kali
          Pin-Priority: 500
          EOF
          sudo apt-get update

          # 3.  install single tools (no meta-package) + xfce + xrdp
          sudo apt-get install -y \
            metasploit-framework nmap burpsuite john hashcat gobuster dirb sqlmap ffuf feroxbuster \
            xfce4 xfce4-goodies xrdp

          # 4.  local user
          sudo useradd -m -s /bin/bash kali 2>/dev/null || true
          echo "kali:${{ secrets.KL_PASS }}" | sudo chpasswd
          sudo usermod -aG sudo kali

          # 5.  xrdp tweaks
          echo "startxfce4" | sudo tee -a /etc/xrdp/startwm.sh
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

          # 6.  playit deb
          curl -L -o /tmp/playit.deb \
            https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit_0.15.26-1_amd64.deb
          sudo dpkg -i /tmp/playit.deb || sudo apt-get -f install -y

      - name: Launch playit tunnel
        env:
          PLAYIT_AUTH_KEY: ${{ secrets.PL }}
        run: |
          playit-agent --secret "$PLAYIT_AUTH_KEY" 2>&1 | tee playit.log &
          for i in {1..60}; do
            addr=$(grep -oP 'https://\K[\w\-\.]+\.ply\.gg:\d+' playit.log | head -n1)
            [[ -n "$addr" ]] && echo ">>> RDP ADDRESS: $addr <<<" && exit 0
            sleep 1
          done
          echo "tunnel not found" && exit 1

      - name: Queue follow-up job (only once)
        if: github.event.inputs.chain != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh workflow run '${{ github.workflow }}' -f chain=true

      - name: Keep runner alive
        run: sleep 21600          # 6 h
