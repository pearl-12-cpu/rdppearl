name: APT-RDP

on:
  workflow_dispatch:
    inputs:
      chain:
        description: 'internal flag, leave empty'
        required: false
        default: 'false'

  schedule:
    - cron: '0 */12 * * *'   # 00:00 and 12:00 UTC every day

jobs:
  setup-rdp-tunnel:
    runs-on: windows-latest
    timeout-minutes: 360          # 6 h hard cap

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Playit
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-windows-x86_64-signed.exe" -OutFile "$env:USERPROFILE\playit.exe"

    - name: Configure RDP
      shell: pwsh
      env:
        PASS: ${{ secrets.RDP_PASS }}
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
        Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText $env:PASS -Force)

    - name: Install Essential Tools
      shell: pwsh
      run: |
        # Install 7-Zip
        Write-Host "Installing 7-Zip..."
        Invoke-WebRequest -Uri "https://www.7-zip.org/a/7z2408-x64.msi" -OutFile "$env:TEMP\7z.msi"
        Start-Process "msiexec" -ArgumentList "/i", "$env:TEMP\7z.msi", "/quiet", "/norestart" -Wait
        
        # Install VLC Portable
        Write-Host "Installing VLC Portable..."
        Invoke-WebRequest -Uri "https://download.videolan.org/pub/vlc/3.0.21/win64/vlc-3.0.21-win64.7z" -OutFile "$env:TEMP\vlc.7z"
        & "C:\Program Files\7-Zip\7z.exe" x "$env:TEMP\vlc.7z" -o"C:\Program Files\VLC" -y -bso0
        
        # Install Opera Browser (using direct download link)
        Write-Host "Installing Opera..."
        Invoke-WebRequest -Uri "https://download1.operacdn.com/pub/opera/desktop/110.0.5131.0/win/Opera_110.0.5131.0_Setup_x64.exe" -OutFile "$env:TEMP\opera.exe"
        Start-Process "$env:TEMP\opera.exe" -ArgumentList "/silent", "/launchbrowser=0", "/install" -Wait
        
        # Install Lossless Cut
        Write-Host "Installing Lossless Cut..."
        Invoke-WebRequest -Uri "https://github.com/mifi/lossless-cut/releases/latest/download/LosslessCut.exe" -OutFile "C:\Windows\System32\LosslessCut.exe"
        
        Write-Host "All tools installed successfully!"

    - name: Install Media Tools (yt-dlp + ffmpeg)
      shell: pwsh
      run: |
        # Install yt-dlp
        Write-Host "Installing yt-dlp..."
        Invoke-WebRequest -Uri "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe" -OutFile "C:\Windows\System32\yt-dlp.exe"
        
        # Install ffmpeg
        Write-Host "Installing ffmpeg..."
        $fftmp = "$env:TEMP\ff"; mkdir $fftmp -Force >$null;
        Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile "$fftmp\ffmpeg.zip";
        Expand-Archive -Path "$fftmp\ffmpeg.zip" -DestinationPath "$fftmp" -Force;
        Get-ChildItem "$fftmp\ffmpeg-*\bin\*.exe" | Copy-Item -Destination "C:\Windows\System32\" -Force;
        
        # Create desktop shortcuts
        Write-Host "Creating desktop shortcuts..."
        $WshShell = New-Object -comObject WScript.Shell
        $Shortcut = $WshShell.CreateShortcut("$env:USERPROFILE\Desktop\Lossless Cut.lnk")
        $Shortcut.TargetPath = "C:\Windows\System32\LosslessCut.exe"
        $Shortcut.WorkingDirectory = "C:\Windows\System32"
        $Shortcut.Save()
        
        $Shortcut = $WshShell.CreateShortcut("$env:USERPROFILE\Desktop\VLC Player.lnk")
        $Shortcut.TargetPath = "C:\Program Files\VLC\vlc.exe"
        $Shortcut.WorkingDirectory = "C:\Program Files\VLC"
        $Shortcut.Save()
        
        $Shortcut = $WshShell.CreateShortcut("$env:USERPROFILE\Desktop\Opera Browser.lnk")
        $Shortcut.TargetPath = "C:\Program Files\Opera\launcher.exe"
        $Shortcut.Save()

    - name: Create Download Script
      shell: pwsh
      run: |
        # Create download script on desktop
        $downloadScript = @'
        @echo off
        chcp 65001 >nul
        echo ===============================
        echo    YouTube Download Script
        echo ===============================
        echo.
        if "%1"=="" (
        set /p "url=Enter YouTube URL: "
        ) else (
        set "url=%1"
        )
        echo Downloading: %url%
        yt-dlp -N 8 -o "%USERPROFILE%\Downloads\%(title)s-%(height)sp.%(ext)s" "%url%"
        if %errorlevel% equ 0 (
        echo Download completed successfully!
        ) else (
        echo Download failed with error code %errorlevel%
        )
        pause
        '@
        $downloadScript | Out-File -FilePath "$env:USERPROFILE\Desktop\Download.bat" -Encoding ASCII

    - name: Show tunnel address
      shell: pwsh
      env:
        PLAYIT_AUTH_KEY: ${{ secrets.PL }}
      run: |
        # Start playit in foreground
        $arg = '--secret', $env:PLAYIT_AUTH_KEY
        & "$env:USERPROFILE\playit.exe" $arg 2>&1 | Tee-Object -Variable out

        # Find the tunnel URL
        $m = $out | Select-String -Pattern 'https://([\w\-\.]+\.ply\.gg:\d+)' | Select-Object -First 1
        if ($m) {
            $addr = $m.Matches.Groups[1].Value
            Write-Host "`n>>> RDP ADDRESS: $addr <<<`n"
        } else {
            Write-Host "no tunnel URL found"
            exit 1
        }

    # ---------- chaining logic ----------
    - name: Queue follow-up job (only once)
      if: github.event.inputs.chain != 'true'
      shell: pwsh
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh workflow run '${{ github.workflow }}' -f chain=true

    # ---------- keep alive ----------
    - name: Keep runner alive
      shell: pwsh
      run: Start-Sleep 21600        # 6 h
