
name: Kali-RDP-Mobile-Manual

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Runtime in minutes (max 360)'
        required: false
        default: '180'

jobs:
  kali-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repository (includes manual playit binary)
        uses: actions/checkout@v4

      - name: Setup Ubuntu Desktop with Security Tools
        run: |
          set -e
          echo "ğŸ”§ Starting installation process..."
          
          sudo add-apt-repository universe -y
          sudo add-apt-repository multiverse -y
          sudo apt-get update
          
          echo "ğŸ“€ Installing desktop environment..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies \
            xrdp \
            firefox \
            nano vim curl wget unzip git

          echo "ğŸ› ï¸ Installing security tools..."
          sudo apt-get install -y \
            nmap nikto sqlmap gobuster dirb ffuf \
            python3 python3-pip python3-venv \
            john hashcat hydra wireshark tcpdump \
            netcat-openbsd

          # Create user
          sudo useradd -m -s /bin/bash kali 2>/dev/null || true
          echo "kali:kali123456" | sudo chpasswd
          sudo usermod -aG sudo kali

          # Configure xrdp
          sudo sed -i 's/port=3389/port=3390/g' /etc/xrdp/xrdp.ini
          echo "xfce4-session" | sudo tee /etc/xrdp/startwm.sh
          sudo chmod +x /etc/xrdp/startwm.sh

          # Start RDP service
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

          echo "âœ… Desktop environment ready!"

      - name: Install Additional Python Tools
        run: |
          pip3 install requests bs4 scrapy
          echo "âœ… Python tools installed"

      - name: Setup Playit Tunnel (LATEST VERSION - NO TUNNEL ARG)
        env:
          PLAYIT_KEY: ${{ secrets.PLAYIT_KEY }}
        run: |
          echo "ğŸŒ Setting up Playit tunnel using manually uploaded binary..."
          
          # Use the manually uploaded binary
          echo "ğŸ“ Using local playit binary..."
          cp ./binaries/playit ./playit
          
          # Verify it's a real binary
          echo "ğŸ” Verifying binary..."
          file playit
          ls -lh playit
          echo "ğŸ“ File size: $(wc -c < playit) bytes"
          
          if ! file playit | grep -q "ELF"; then
            echo "âŒ ERROR: File is not a valid binary!"
            exit 1
          fi
          
          # Make executable and install
          chmod +x playit
          sudo mv playit /usr/local/bin/
          echo "âœ… Playit installed successfully"

          # Start tunnel - NEW VERSION SYNTAX (no --tunnel argument)
          echo "ğŸš€ Starting tunnel..."
          echo "ğŸ“ Playit agent starting - it will automatically detect RDP on port 3390"
          /usr/local/bin/playit --secret "$PLAYIT_KEY" 2>&1 | tee playit.log &
          TUNNEL_PID=$!
          
          # Wait for tunnel to establish
          echo "â³ Waiting for tunnel agent to connect (up to 90 seconds)..."
          for i in {1..90}; do
            if grep -q "agent_id" playit.log || grep -q "connected" playit.log || grep -q "registered" playit.log; then
              echo "âœ… Playit agent connected after $i seconds!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "â° Still waiting... (30 seconds)"
              echo "ğŸ“‹ Current log:"
              tail -5 playit.log
            fi
            if [ $i -eq 60 ]; then
              echo "â° Still waiting... (60 seconds)"
              echo "ğŸ“‹ Current log:"
              tail -5 playit.log
            fi
            sleep 1
          done
          
          # Give it more time to establish the tunnel
          echo "â³ Giving tunnel more time to establish..."
          sleep 15
          
          # Check if agent connected successfully
          if grep -q "agent_id" playit.log; then
            echo "ğŸ¯ PLAYIT TUNNEL SETUP COMPLETE!"
            echo ""
            echo "ğŸ“‹ Connection Instructions:"
            echo "1. Go to: https://playit.gg/account/tunnels"
            echo "2. Find your RDP tunnel (should be on port 3390)"
            echo "3. Use the address shown there for RDP connection"
            echo ""
            echo "ğŸ”‘ RDP Login Details:"
            echo "Username: kali"
            echo "Password: kali123456"
            echo ""
            echo "ğŸŒ Your RDP will be available at the address shown on playit.gg"
            echo "ğŸ“± Use Windows RDP app on your phone with those details"
            echo ""
            echo "ğŸ“Š Tunnel Status:"
            grep -E "agent_id|connected|registered|tunnel" playit.log | tail -10
          else
            echo "âŒ Playit agent failed to connect"
            echo "ğŸ“‹ Full log for debugging:"
            cat playit.log
            echo "ğŸ’¡ Check your PLAYIT_KEY secret and try again"
            exit 1
          fi

      - name: Keep Alive with Countdown
        run: |
          DURATION=${{ github.event.inputs.duration || 180 }}
          echo "ğŸ• RDP session active for $DURATION minutes"
          echo ""
          echo "ğŸ¯ REMEMBER:"
          echo "1. Go to https://playit.gg/account/tunnels"
          echo "2. Find your RDP tunnel address"
          echo "3. Connect with: kali / kali123456"
          echo ""
          echo "ğŸ”§ Tools available: nmap, sqlmap, ffuf, gobuster, wireshark, etc."
          echo "ğŸ’¡ The RDP tunnel is now active - connect from your phone!"
          
          MINUTES=$DURATION
          for ((i=MINUTES; i>0; i--)); do
            echo "â³ Time remaining: ${i} minutes"
            sleep 60
          done
          echo "âŒ Session ending now"
