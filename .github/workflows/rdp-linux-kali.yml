
name: Kali-RDP-Mobile

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Runtime in minutes (max 360)'
        required: false
        default: '180'

jobs:
  kali-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Setup Ubuntu Desktop with Security Tools
        run: |
          set -e
          echo "üîß Starting installation process..."
          
          # Update system first
          sudo apt-get update
          sudo apt-get upgrade -y
          
          # Install desktop environment first
          echo "üìÄ Installing desktop environment..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies \
            xrdp \
            firefox \
            nano vim curl wget unzip

          # Install security tools in separate commands to avoid failures
          echo "üõ†Ô∏è Installing security tools..."
          sudo apt-get install -y nmap
          sudo apt-get install -y nikto
          sudo apt-get install -y sqlmap
          sudo apt-get install -y gobuster
          sudo apt-get install -y dirb
          sudo apt-get install -y ffuf
          sudo apt-get install -y python3 python3-pip python3-venv
          sudo apt-get install -y metasploit-framework
          sudo apt-get install -y john
          sudo apt-get install -y hashcat
          sudo apt-get install -y hydra
          sudo apt-get install -y wireshark
          sudo apt-get install -y tcpdump
          sudo apt-get install -y netcat
          sudo apt-get install -y git binutils

          # Install Python tools
          pip3 install requests bs4 scrapy

          # Create user with secure password
          sudo useradd -m -s /bin/bash kali 2>/dev/null || true
          echo "kali:kali123456" | sudo chpasswd
          sudo usermod -aG sudo kali

          # Configure xrdp
          sudo sed -i 's/port=3389/port=3390/g' /etc/xrdp/xrdp.ini
          echo "xfce4-session" | sudo tee /etc/xrdp/startwm.sh
          sudo chmod +x /etc/xrdp/startwm.sh

          # Start RDP service
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

          echo "‚úÖ Desktop environment ready!"

      - name: Install Feroxbuster
        run: |
          # Install feroxbuster via direct download
          wget -q https://github.com/epi052/feroxbuster/releases/download/2.10.0/feroxbuster-v2.10.0-linux-x86_64.zip
          unzip -o feroxbuster-v2.10.0-linux-x86_64.zip
          sudo mv feroxbuster /usr/local/bin/
          sudo chmod +x /usr/local/bin/feroxbuster
          echo "‚úÖ Feroxbuster installed"

      - name: Verify Tools Installation
        run: |
          echo "üîç Verifying installed tools..."
          which nmap && nmap --version | head -1
          which nikto && nikto -version | head -1
          which sqlmap && sqlmap --version
          which gobuster && gobuster version
          which ffuf && ffuf -version
          which feroxbuster && feroxbuster -V
          which msfconsole && msfconsole --version
          echo "‚úÖ All tools verified!"

      - name: Setup Playit Tunnel (RDP Access)
        env:
          PLAYIT_KEY: ${{ secrets.PLAYIT_KEY }}
        run: |
          echo "üåê Setting up Playit tunnel..."
          # Download and setup playit
          wget -q https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-linux-x86_64-v0.15.26.tar.gz
          tar -xzf playit-linux-x86_64-v0.15.26.tar.gz
          sudo mv playit /usr/local/bin/
          sudo chmod +x /usr/local/bin/playit

          # Start tunnel in background
          nohup playit --secret "$PLAYIT_KEY" --tunnel 3390 > playit.log 2>&1 &
          sleep 20

          # Get connection details
          TUNNEL_URL=$(grep -o 'https://[^ ]*\.ply\.gg' playit.log | head -1)
          if [ -z "$TUNNEL_URL" ]; then
            echo "‚ùå Failed to get tunnel URL"
            cat playit.log
            exit 1
          fi
          
          echo "üéØ RDP Connection Details:" 
          echo "Address: $TUNNEL_URL"
          echo "Port: 3390"
          echo "Username: kali"
          echo "Password: kali123456"
          echo "üì± Use Windows RDP app on your phone to connect!"

      - name: Keep Alive with Countdown
        run: |
          # Use the input duration or default to 180 minutes
          DURATION=${{ github.event.inputs.duration || 180 }}
          echo "üïê RDP session active for $DURATION minutes"
          echo "‚è∞ Session started at: $(date)"
          echo "üîå Will auto-terminate at: $(date -d '+$DURATION minutes')"
          echo ""
          echo "üîß Available tools: nmap, nikto, sqlmap, metasploit, gobuster, ffuf, feroxbuster, john, hashcat, hydra"
          echo ""
          
          # Countdown timer
          MINUTES=$DURATION
          for ((i=MINUTES; i>0; i--)); do
            echo "‚è≥ Time remaining: ${i} minutes"
            sleep 60
          done
          echo "‚ùå Session ending now"
