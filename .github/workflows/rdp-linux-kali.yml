
name: Kali-RDP-Mobile

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Runtime in minutes (max 360)'
        required: false
        default: '180'

jobs:
  kali-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Setup Ubuntu Desktop with Security Tools
        run: |
          set -e
          echo "üîß Starting installation process..."
          
          # Add necessary repositories
          sudo add-apt-repository universe -y
          sudo add-apt-repository multiverse -y
          sudo apt-get update
          
          # Install desktop environment
          echo "üìÄ Installing desktop environment..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies \
            xrdp \
            firefox \
            nano vim curl wget unzip git

          # Install security tools that WORK
          echo "üõ†Ô∏è Installing security tools..."
          sudo apt-get install -y \
            nmap nikto sqlmap gobuster dirb ffuf \
            python3 python3-pip python3-venv \
            john hashcat hydra wireshark tcpdump \
            netcat-openbsd

          # Create user
          sudo useradd -m -s /bin/bash kali 2>/dev/null || true
          echo "kali:kali123456" | sudo chpasswd
          sudo usermod -aG sudo kali

          # Configure xrdp
          sudo sed -i 's/port=3389/port=3390/g' /etc/xrdp/xrdp.ini
          echo "xfce4-session" | sudo tee /etc/xrdp/startwm.sh
          sudo chmod +x /etc/xrdp/startwm.sh

          # Start RDP service
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

          echo "‚úÖ Desktop environment ready!"

      - name: Install Additional Python Tools
        run: |
          pip3 install requests bs4 scrapy
          echo "‚úÖ Python tools installed"

      - name: Setup Playit Tunnel (CORRECTED URL)
        env:
          PLAYIT_KEY: ${{ secrets.PLAYIT_KEY }}
        run: |
          echo "üåê Setting up Playit tunnel..."
          
          # CORRECT URL (using dots, not underscores, and correct spelling)
          PLAYIT_URL="https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-linux-x86_64"
          echo "üì• Downloading from: $PLAYIT_URL"
          
          # Download with verification
          if ! wget -q "$PLAYIT_URL" -O playit; then
            echo "‚ùå wget failed, trying curl..."
            curl -L "$PLAYIT_URL" -o playit
          fi
          
          # VERIFY the download is actually a binary (not HTML error page)
          file playit | grep -q "ELF" || {
            echo "‚ùå Downloaded file is not a binary - it's probably an HTML error page"
            echo "üìã File type: $(file playit)"
            echo "üìã First few bytes: $(head -c 100 playit)"
            exit 1
          }
          
          echo "‚úÖ Download verified - it's a real binary"
          echo "üìè File size: $(wc -c < playit) bytes"
          
          # Make executable and install
          chmod +x playit
          sudo mv playit /usr/local/bin/
          echo "‚úÖ Playit installed"

          # Start tunnel
          echo "üöÄ Starting tunnel..."
          /usr/local/bin/playit --secret "$PLAYIT_KEY" --tunnel 3390 2>&1 | tee playit.log &
          TUNNEL_PID=$!
          
          # Wait for tunnel to establish
          echo "‚è≥ Waiting for tunnel to establish (this can take 30-60 seconds)..."
          for i in {1..90}; do
            if grep -q "https://.*\.ply\.gg" playit.log; then
              echo "‚úÖ Tunnel established!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "‚è∞ Still waiting... (30 seconds passed)"
            fi
            if [ $i -eq 60 ]; then
              echo "‚è∞ Still waiting... (60 seconds passed)"
            fi
            sleep 1
          done
          
          # Extract address with multiple pattern attempts
          ADDRESS=$(grep -oP 'https://\K[\w\-\.]+\.ply\.gg:\d+' playit.log | head -1)
          if [ -z "$ADDRESS" ]; then
            ADDRESS=$(grep -o 'tunnel started at: https://[^ ]*' playit.log | cut -d' ' -f4 | cut -d'/' -f3)
          fi
          if [ -z "$ADDRESS" ]; then
            ADDRESS=$(grep -o 'https://[a-zA-Z0-9.-]*\.ply\.gg:[0-9]*' playit.log | head -1 | cut -d'/' -f3)
          fi
          
          if [ -n "$ADDRESS" ]; then
            echo ""
            echo "üéØ üéØ üéØ RDP CONNECTION DETAILS üéØ üéØ üéØ"
            echo ">>> RDP ADDRESS: $ADDRESS <<<"
            echo "Username: kali"
            echo "Password: kali123456"
            echo ""
            echo "üì± In Windows RDP app:"
            echo "Computer: $(echo $ADDRESS | cut -d: -f1)"
            echo "Port: $(echo $ADDRESS | cut -d: -f2)"
            echo "üéØ üéØ üéØ"
          else
            echo "‚ùå No tunnel URL found after 90 seconds"
            echo "üìã Checking log for errors:"
            grep -i "error\|fail\|warn" playit.log || echo "No obvious errors in log"
            echo "üìã Recent log:"
            tail -20 playit.log
            echo "‚ùå Tunnel failed - cannot provide connection details"
            exit 1
          fi

      - name: Keep Alive with Countdown
        run: |
          DURATION=${{ github.event.inputs.duration || 180 }}
          echo "üïê RDP session active for $DURATION minutes"
          echo "üí° If connection details above didn't show, the tunnel failed"
          echo "üîß Tools available: nmap, sqlmap, ffuf, gobuster, etc."
          
          MINUTES=$DURATION
          for ((i=MINUTES; i>0; i--)); do
            echo "‚è≥ Time remaining: ${i} minutes"
            sleep 60
          done
          echo "‚ùå Session ending now"
